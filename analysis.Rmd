---
title: "HCC_GeoMx_HepComms"
author: "Chen Lu"
date: "2024-06-30"
output: html_document
---

# Setup 
### packages
```{r setup, include=TRUE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(readxl)
library(bswClst10)
library(CCA)
library(lme4)
library(lmerTest)
library(ggrepel)
library(foreach)
library(ggplot2)
library(ggpmisc)
library(ggforce)
library(corrplot)
library(ggpubr)
library(gridExtra)
library(ggridges)
library(GGally)
library(lubridate)
library(matrixStats)
library(scales)
library(reshape2)  # for melt
library(cowplot)   # for plot_grid
library(EnvStats)
library(mixOmics) # call mixOmics library
library(Seurat)
library(factoextra)
library(FactoMineR)
library(ComplexHeatmap)
library(survival)
library(survminer)
```

### paths and colors
```{r}
data_path <- '/Users/chenyuelu/iCloud/Desktop/things/HST/research/HCC/manuscript/data'
output_path <- '/Users/chenyuelu/iCloud/Desktop/things/HST/research/HCC/manuscript/results'
tissue_colors <- list('Tissue_Type'=c('Tumor'='forestgreen','Vessel'='red'))
Hoshida_colors <- list('Hoshida_type'=c('S1'='black','S2'='dodgerblue3','S3'='green','Others'='ghostwhite'))
tstage_colors <- list('tstage' = c('1'='forestgreen', '2'='yellow', '3'='orange', '4'='red','NA'='lightgrey'))
fibrosis_colors <- list('fibrosis' = c('0'='forestgreen', '2'='cyan1', '3'='yellow', '4'='orange', '5'='red', '6'='purple', 'NA'='grey'))
differentiation_colors <- list('differentiation' = c('well'='forestgreen', 'moderate'='yellow', 'moderate_poor'='orange', 'poor'='black','NA'='grey'))
T1T2T3_colors <- list('subtype'=c('T1'='red','T2'='blue','T3'='purple','Others'='lightgrey'))
V1V2_colors <- list('subtype'=c('V1'='orange','V2'='dodgerblue3','Others'='lightgrey'))
```

### load GeoMx normalized counts and associated meta data 

```{r include=TRUE, eval=TRUE}
##### load up files from nanostring workflow qc results #####
cts <- read.delim(paste0(data_path,'/qnormCounts.tsv')) # generated using NS workflow script

# shorten sample names
colnames(cts) <- gsub('\\.','-',colnames(cts))
colnames(cts) <- gsub('.dcc','',colnames(cts))
colnames(cts) <- gsub('DSP-100166000','',colnames(cts))

##### meta file #####
meta<-read_excel(paste0(data_path,'/HCCPatientID.xlsx')) %>% 
  mutate(Sample_ID_short=gsub('DSP-100166000','',Sample_ID)) %>%
  dplyr::select(-c('...12'))

meta <- meta %>% 
    mutate(Tissue_Type = case_when((segment=='Arginase+' & Comments=='Vessel') ~ 'Tumor',
                                 (segment=='CD31+' & Comments=='Tumor') ~ 'Vessel',
                                 TRUE ~ Comments)) %>% # fixed four AOIs
    mutate(Sample_ID_short=substr(Sample_ID,14,nchar(Sample_ID))) %>%  
    mutate(Slide_Type = case_when(str_detect(`slide name`,'TMA')~'TMA',
                                  str_detect(`slide name`,'Control')~'Ctrl',
                                  TRUE ~ 'Whole Slide')) %>%
    mutate(path_number_short = map_chr(str_extract_all(str_extract(get('Surgical ID'),'[:alpha:]*\\d\\d\\_*[:alpha:]*\\d+'), '\\d+'), ~ str_c(.x, collapse="_"))) # standardize path_number ('Surgical ID') 

meta_OG <- meta
```

### Hoshida gene sets

```{r eval=TRUE}
HoshidaGenes<-NA
for (i in 1:3){
  t<-read.delim(paste0(data_path,'/Hoshida_S',i,'.txt'))
  t<-data.frame(t[2:nrow(t),],rep(i,nrow(t)-1))
  HoshidaGenes<-rbind(HoshidaGenes, t) %>% na.omit()
} 
colnames(HoshidaGenes)<-c('Genes','Set')
```


### match with clinical database

```{r include=TRUE, eval=TRUE, warning=FALSE}
##### columns of interest #####
survival <- read_excel(paste0(data_path, '/210_cases_oct9_2018_hcc_completed_database1_Emmett_08012022.xlsx'), sheet = 'clindata', range = cell_cols("A:AI"), col_types = c('text', 'numeric','text','numeric','text','date','numeric','date','date','text','text','text','text','text','date','date','text','numeric','numeric','numeric','numeric','text','text','text','text','text','text','text','text','text','text','text','text','text','text')) %>% head(210) %>% 
  mutate(path_number_short = map_chr(str_extract_all(str_extract(path_number,'[:alpha:]*\\d\\d\\_*[:alpha:]*\\d+'), '\\d+'), ~ str_c(.x, collapse="_"))) # standardize path number

##### manually fix a few entries #####
survival[survival$mrn=='3859992',]$surg_date <- as.Date('2011-12-2')
survival[survival$mrn=='519888',]$surg_date <- as.Date('2006-5-2')
survival[survival$mrn=='2404949',]$Gender_1M_2F <- '1'
survival[survival$mrn=='2404949',]$hcc_dx_date <- as.Date('2004-12-01')
survival[survival$mrn=='4475336',]$Gender_1M_2F <- '1' 
survival[survival$mrn=='4475336',]$hcc_dx_date <- as.Date('2007-3-19') # there are two different diagnosis dates -> I am choosing the slightly later one but it should not affect the results
survival[survival$mrn=='4620118',]$hcc_dx_date <- as.Date('2008-6-18')
survival[survival$mrn=='4097569',]$hcc_dx_date <- as.Date('2012-1-26')
survival[survival$mrn=='3956791',]$death_date <- as.Date('2016-4-1') # for some reason death date was not read in for this patient
survival <- survival %>% filter(path_number!='MS07_19307_C3') # remove this bc it was an biopsy from OSH and later repeated with MS07_G19307.
```

### merge tables

```{r include=TRUE, eval=TRUE}
# merge survival and meta data and only keep useful columns
meta <- meta_OG
meta <- merge(meta, survival, by = 'path_number_short', all.x = TRUE) %>% 
  filter(Sample_ID_short %in% colnames(cts)) %>%
  drop_na(Sample_ID_short) %>% 
  mutate(status = case_when(!(is.na(death_date)) ~ 1, # I am doing this case_when statement bc two patients had both death_date and Last_Follow_up
                            TRUE ~ 0)) %>% # status == 1 means dead, status == 0 means censored 
  mutate(fu_date = case_when(!(is.na(death_date)) ~ death_date,
                            TRUE ~ Last_Follow_up)) %>% 
  mutate(time = difftime(fu_date, surg_date,  units = "days")) %>%
  dplyr::select(-c('panel','Comments','case','os_days_fromsurgery_5yearsmax','death1.censored0.5years','os_days_fromsurgery','OS.death1.censored0.','MRN','Age_surgery','Last_Follow_up','death','segment','aoi','Surgical ID','Sample_ID','CaseID','preop_tx_1','preop_tx_2')) %>%
  mutate(etiology = case_when(etiology1 %in% c('hcv','hbv') ~ 'viral',
                              is.na(etiology1) ~ 'NA',
                              TRUE ~ etiology1))

# only want resection or transplant samples
meta <- meta %>% filter(sample %in% c('resection','transplant'))

# create unique patient ID to remove identifiers
meta <- meta %>%                                  
  group_by(mrn) %>%
  dplyr::mutate(ID = cur_group_id()) %>% 
  ungroup()
meta$ID <- as.factor(meta$ID)

cts <- cts[,colnames(cts) %in% meta$Sample_ID_short]
```


### export patient clinical info summary
```{r, include=TRUE, eval=TRUE}
clin_info <- meta %>% mutate(Sex = case_when(Gender_1M_2F==1 ~ 'M',
                         Gender_1M_2F==2 ~ 'F')) %>% 
  group_by(ID, Sex, status, time, serum_afp, tbili, alb, inr, etiology, tumor_number, tumor_size, differentiation, tstage, nstage, lvi, pni, fibrosis, steatosis) %>%
  summarise(AOI_count = n_distinct(Sample_ID_short)) %>% 
  ungroup() 
  
head(clin_info)
write.csv(clin_info,paste0(output_path,'/clinical_summary.csv'))
```


### heatmap of tumor and vessel AOIs altogether 

```{r, include=TRUE, eval=TRUE}
##### both tumor and vessel together #####
meta_here <- meta 
colpheno<-data.frame(meta_here %>%  
                       dplyr::select(Tissue_Type),
                     row.names=meta_here$Sample_ID_short)
rowPheno<-data.frame('Hoshida_type' = 
                       case_when(rownames(cts) %in% HoshidaGenes[HoshidaGenes$Set=='1',]$Genes ~ 'S1',
                                 rownames(cts) %in% HoshidaGenes[HoshidaGenes$Set=='2',]$Genes ~ 'S2',
                                 rownames(cts) %in% HoshidaGenes[HoshidaGenes$Set=='3',]$Genes ~ 'S3',
                                 TRUE ~ 'Others'))
rownames(rowPheno) <- rownames(cts)

cts_here <- cts[,colnames(cts) %in% meta_here$Sample_ID_short]
cts_here <- t(scale(t(log2(cts_here)), scale = F)) # normalize by gene

topGenes <- 500
clst<-bswClst.clust(cts_here,topNSdRows=topGenes, medianPolish = F, clusterRows = T, clusterCols = T)

# short format
save_path = paste0(output_path, '/GeoMx_tumor&vessel_heatmap_short_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colNamesTopJust=F,colNamesTopPlot=F,colPhenoColorMaps = tissue_colors,
                   rowPheno=rowPheno,rowDendroPlot=T,rowNamesLeftJust=F,rowNamesLeftPlot=F,rowPhenoColorMaps = Hoshida_colors, 
                   heatmapHeight='golden',
                   heatmapAutoZlimMethod='range',
                   legendGex=4,fontsize = 15,legendIndent = 0, legendOffset=0.3,
                   heatmapColorRampGamma=5,heatmapRampGex=3
                   )

# long format
save_path = paste0(output_path, '/GeoMx_tumor&vessel_heatmap_long_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colNamesTopJust=F,colNamesTopPlot=F,colPhenoColorMaps = tissue_colors, 
                   rowPheno=rowPheno,rowDendroPlot=T,rowPhenoColorMaps = Hoshida_colors,rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   legendGex=4,fontsize = 15,legendIndent = 0, legendOffset=0.3,
                   heatmapAutoZlimMethod='range',heatmapRampGex=3,
                   heatmapColorRampGamma=5)

# only selected genes
cts_here_subset <- cts_here[rownames(cts_here) %in%
  c('ARG1', 'APOA2', 'APOB', 'APOC2', 'CCL16', 'CRP', 'F12', 'FN1', 'IL32', 'LBP', 'OTC', 'SERPINA1', 'SOD1', 'TTR', 'VEGFA', # cancer
    'CD34', 'CDH5', 'ENG', 'ETS', 'FLT1', 'IL33', 'JAG1', 'KDR', 'MCAM', 'NOTCH3', 'PECAM1', 'SPRY1', 'STC1', 'THY1', 'TIE1'),] # vessel
clst<-bswClst.clust(cts_here_subset,topNSdRows=200, medianPolish = F, clusterRows = T, clusterCols = T)
save_path = paste0(output_path, '/GeoMx_tumor&vessel_heatmap_subset.pdf')
colpheno<-data.frame(meta_here %>%  dplyr::select(Tissue_Type) ,
                     row.names=meta_here$Sample_ID_short)
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colNamesTopJust=F,colNamesTopPlot=F,colPhenoColorMaps = tissue_colors,
                   rowDendroPlot=T,rowPhenoColorMaps = Hoshida_colors,rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   heatmapAutoZlimMethod='range',
                   legendGex=4,fontsize = 15,legendIndent = 0, legendOffset=0.3,heatmapRampGex=2,
                   heatmapColorRampGamma=5)

# only Hoshida genes
rowPheno_Hoshida <- rowPheno %>% filter(Hoshida_type!='Others')
cts_here <- cts[rownames(cts)%in% rownames(rowPheno_Hoshida),] # keep only Hoshida genes
cts_here <- cts_here[,colnames(cts_here) %in% meta_here$Sample_ID_short] # keep only samples in meta
cts_here <- t(scale(t(log2(cts_here)), scale = F)) # normalize by gene

clst<-bswClst.clust(cts_here,topNSdRows=200, medianPolish = F, clusterRows = T, clusterCols = T)
save_path = paste0(output_path, '/GeoMx_tumor&vessel_heatmap_Hoshida.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colNamesTopJust=F,colNamesTopPlot=F,colPhenoColorMaps = tissue_colors, 
                   rowPheno=rowPheno,rowDendroPlot=T,rowPhenoColorMaps = Hoshida_colors,rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   legendGex=4,fontsize = 15,legendIndent = 0, legendOffset=0.3,heatmapRampGex=2,
                   heatmapAutoZlimMethod='range',heatmapColorRampGamma=5
                   )
```


### differential expression analysis function 
```{r}
get_diffexp<-function(df,de,test_name){
  # df is a counts table, after q3 normalization
  # de is a data frame of sample names and groups to perform DE on
  # test_name is the type of statistical test, which depends on the actual test and its associated assumptions. options are 'wilcoxon','t_test', and 'lme'
  df <- as.data.frame(t(scale(t(log2(df)), scale = F))) # log2 transform the counts and center each gene so that they all have mean of 0
  # mean centering should not change the test results 
  typ<- as.factor(de[,2])
  diffexp <- foreach(cl = levels(typ), .combine=cbind) %do% {
    idx<-typ==cl
    idx[is.na(idx)] <- FALSE
    rowMeans(df[,idx],na.rm=T)
  } # Calculate group means.
  diffexp <- as.data.frame(diffexp)
  colnames(diffexp) <- levels(typ)
  test<-combn(1:ncol(diffexp),2)
  for (n in 1:ncol(test)){
    cn<-colnames(diffexp)
    g1<-test[1,n]
    g2<-test[2,n]
    t1<-levels(typ)[g1]
    t2<-levels(typ)[g2]
    
    diffexp$LFC<-diffexp[,g1] - diffexp[,g2]
    if(test_name == 'lme'){
      df_full <- as.data.frame(t(df[, typ %in% c(t1, t2)])) %>% rownames_to_column(var='Sample_ID_short')
      df_full <- merge(df_full,meta[c('Sample_ID_short','ID')]) 
      print(unique(df_full$ID))
      rownames(df_full) <- df_full$Sample_ID_short
      df_full <- merge(df_full,de,by=0)
      diffexp$p_lme <- foreach(i = 1:nrow(df), .combine=c) %do% {
        summary(lmerTest::lmer(as.formula(paste0('`',rownames(df)[i], "`~", colnames(de)[2], "+ (1 | ID)")), data=df_full))[10]$coefficients[2,5]
      }
    }
    if(test_name == 'Wilcoxon'){
      diffexp$p<- foreach(i = 1:nrow(df), .combine=c) %do% {
          wilcox.test(as.numeric(df[i, typ==t1]), as.numeric(df[i, typ==t2]), exact=FALSE)$p.value # Calculate Wilcoxon Rank Sum p-value
        }
      }
    if(test_name == 't_test'){
      diffexp$p <- foreach(i = 1:nrow(df), .combine=c) %do% {
          t.test(as.numeric(df[i, typ==t1]), as.numeric(df[i, typ==t2]))$p.value # t test p-values
        }
    }
    diffexp$padj<-(p.adjust(diffexp$p,method='fdr'))
    colnames(diffexp)<-c(cn,paste0('LFC_',t1,'_',t2),paste0('p_',t1,'_',t2),
                         paste0('padj_',t1,'_',t2))
  }
  return(diffexp)
}
```

### volcano plot comparing tumor and vessel AOIs
```{r}
df<- cts
de <- meta %>% dplyr::select(Sample_ID_short, Tissue_Type) %>% as.data.frame()
rownames(de) <- de$Sample_ID_short
df <- df[,colnames(df) %in% rownames(de)]
de <- de[match(colnames(df), rownames(de)),]
df <- df[,match(rownames(de),colnames(df))]

colnames(df) == rownames(de)# double check
dea<-get_diffexp(df,de,'lme')  

# color by Tumor vs Vessel 
diffexp <- dea %>% mutate(delabel = case_when((padj_Tumor_Vessel < 0.05 & LFC_Tumor_Vessel < -1) ~ 'Vessel',
                                                  (padj_Tumor_Vessel < 0.05 & LFC_Tumor_Vessel > 1) ~ 'Tumor',
                                                  TRUE ~ 'Neither'))
diffexp$lbl<-NA
diffexp$lbl[diffexp$delabel != 'Neither']<-rownames(diffexp)[diffexp$delabel != 'Neither']

write.csv(diffexp, paste0(output_path,'/GeoMx_Tum_vs_Vessel_dea.csv'))
pdf(paste0(output_path,'/GeoMx_Tum_vs_Vessel_dea.pdf'))
tmp<-ggplot(data=diffexp,aes(x=LFC_Tumor_Vessel,y=-log10(padj_Tumor_Vessel),col=delabel, label=lbl)) +
  geom_point() +geom_label_repel(show.legend  = F) +
  xlab(bquote(log[2]("tumor/vessel")))+
  ylab(bquote(-log[10]("adjusted p-value")))+
  theme_classic(base_size = 16)+
  xlim(-3,3)+
  scale_color_manual('DE label',values=tissue_colors$Tissue_Type) +
  geom_vline(xintercept=c(-1,1), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray")+
  theme(axis.text=element_text(size=15),
      axis.title=element_text(size=15),
      legend.title = element_text(size=15),
      legend.text = element_text(size=15))
print(tmp)
dev.off()

# color by Hoshida genes
manual_size <- c(1,1,1,0.3)
names(manual_size) <- c('S1','S2','S3','Others')

diffexp <- dea %>% 
  mutate(gene_label = case_when((rownames(dea) %in% HoshidaGenes[HoshidaGenes$Set=='1',]$Genes) ~ 'S1',
                                              (rownames(dea) %in% HoshidaGenes[HoshidaGenes$Set=='2',]$Genes) ~ 'S2',
                                              (rownames(dea) %in% HoshidaGenes[HoshidaGenes$Set=='3',]$Genes) ~ 'S3',
                                              TRUE ~ 'Others')) %>% 
  mutate(lbl = case_when(abs(LFC_Tumor_Vessel) > 1 & padj_Tumor_Vessel < 0.05 ~ rownames(dea),
                         TRUE ~ ''))

write.csv(diffexp, paste0(output_path,'/GeoMx_Tum_vs_Vessel_dea_Hoshida.csv'))
pdf(paste0(output_path,'/GeoMx_Tum_vs_Vessel_dea_Hoshida_color.pdf'))
tmp<-ggplot(data=diffexp,aes(x=LFC_Tumor_Vessel,y=-log10(padj_Tumor_Vessel),col=gene_label, label=lbl)) +
  geom_point() + theme_classic(base_size = 16) +geom_label_repel(show.legend  = F, max.overlaps = 15) +
  xlim(-3.5, 3.5) +
  xlab(bquote(log[2]("tumor/vessel")))+
  ylab(bquote(-log[10]("adjusted p-value")))+
  scale_color_manual('Hoshida set',values=c('S1'='black','S2'='dodgerblue3','S3'='forestgreen','Others'='gray')) +
  scale_alpha_manual(values=manual_size)+
  geom_vline(xintercept=c(-1,1), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray")+
  guides(color = guide_legend(override.aes = list(size = 3)))+
    theme(axis.text=element_text(size=15),
        axis.title=element_text(size=15),
        legend.title = element_text(size=15),
        legend.text = element_text(size=15))+
  theme(legend.position="bottom")
print(tmp)
dev.off()
```

### Deconvolution of AOIs to show tumor and vessel genes separate out
```{r}
library(SpatialDecon)
colfunc <- colorRampPalette(c("white", "red")) 
cols <- colfunc(10)

Ves <- cts[colnames(cts) %in% meta[meta$Tissue_Type=='Vessel',]$Sample_ID_short]
VMeta<-meta[which(meta$Tissue_Type=='Vessel'),]
exp<-Ves %>% as.matrix()
bg<-derive_GeoMx_background(norm=exp,probepool=rep(1,nrow(exp)),
                            negnames='Negative Probe')
dec<-spatialdecon(norm=exp,bg=bg)
clst<-bswClst.clust(dec$prop_of_all,medianPolish=F)
colpheno<-data.frame(VMeta %>%  dplyr::select(ID) ,
                     row.names=VMeta$Sample_ID_short)
# bswClst.plotToFile(paste0(output_path,'/EndoDecon.pdf'),clst=clst,
#                    colPheno=colpheno,
#                    # heatmapAutoZlimMethod='range',
#                    heatmapZlim = c(0,1),
#                    heatmapColorRamp = cols)
# write.table(dec$prop_of_all,paste0(output_path,'/EndoDeconProp.tsv'),sep='\t',quote=F)

##### tumor #####
Tum <- cts[colnames(cts) %in% meta[meta$Tissue_Type=='Tumor',]$Sample_ID_short]
TMeta<-meta[which(meta$Tissue_Type=='Tumor'),]
exp<-Tum %>% as.matrix()
bg<-derive_GeoMx_background(norm=exp,probepool=rep(1,nrow(exp)),
                            negnames='Negative Probe')
dec<-spatialdecon(norm=exp,bg=bg)
clst<-bswClst.clust(dec$prop_of_all,medianPolish=F)
colpheno<-data.frame(TMeta %>%  dplyr::select(ID) ,
                     row.names=TMeta$Sample_ID_short)
# bswClst.plotToFile(paste0(output_path,'/EpiDecon.pdf'),clst=clst,
#                    colPheno=colpheno,
#                    heatmapZlim = c(0,1),
#                    heatmapColorRamp = cols)
# write.table(dec$prop_of_all,paste0(output_path,'/EpiDeconProp.tsv'),sep='\t',quote=F)
```


### heatmap of AOIs to find clusters
```{r}
matching_aoi<-meta %>% 
  filter(Tissue_Type %in% c('Tumor','Vessel')) %>%
  group_by(`slide name`,roi) %>% 
  dplyr::mutate(count = n_distinct(Tissue_Type)) %>%
  filter(count == 2) %>%
  dplyr::select(Sample_ID_short, `slide name`, roi, Pool, Tissue_Type, ID, etiology) %>%
  spread(Tissue_Type,Sample_ID_short)

##### tumor only #####
meta_here <- meta %>% filter(Tissue_Type=='Tumor') %>% filter(Sample_ID_short %in% matching_aoi$Tumor)
colpheno<-data.frame(meta_here %>%  dplyr::select(tstage, fibrosis, ID,
                                                  # Pool,'slide name','scan name',
                                                  etiology),
                     row.names=meta_here$Sample_ID_short)

cts_here <- cts[,colnames(cts) %in% meta_here$Sample_ID_short]
cts_here <- t(scale(t(log2(cts_here)), scale = F)) # log transform, center by gene, keep variance

topGenes <- 100
clst<-bswClst.clust(cts_here,topNSdRows=topGenes, medianPolish = T, clusterRows = T, clusterCols = T)

# cut tree
cto <- bswClst.cutree2(clst$dc, k = 3)

tumor_clst1 <- cto$leaveLabs[[1]]
tumor_clst2 <- cto$leaveLabs[[2]]
tumor_clst3 <- cto$leaveLabs[[3]]

# append tumor AOI subtype to matching AOIs
matching_aoi <- matching_aoi %>% 
  mutate(subtype = case_when(Tumor %in% tumor_clst1 ~ 'T1',
                             Tumor %in% tumor_clst2 ~ 'T2',
                             Tumor %in% tumor_clst3 ~ 'T3',
                                 TRUE ~ 'Others')) 

# # see breakdown of T1T2T3 subtypes with respect to cell type deconvolution
# meta_here<-matching_aoi
# exp<- Tum %>% dplyr::select(meta_here$Tumor) %>% as.matrix()
# bg<-SpatialDecon::derive_GeoMx_background(norm=exp,probepool=rep(1,nrow(exp)),
#                             negnames='Negative Probe')
# dec<-SpatialDecon::spatialdecon(norm=exp,bg=bg)
# clst<-bswClst.clust(dec$prop_of_all,medianPolish=F)
# colpheno<-data.frame(meta_here[c('subtype')],
#                      row.names=meta_here$Tumor)
# bswClst.plotToFile(paste0(output_path,'/EpiDecon_subtype.pdf'),clst=clst,
#                    colPheno=colpheno,
#                    heatmapZlim = c(0,1),
#                    heatmapColorRamp = cols)

colpheno <- colpheno %>% 
  mutate(subtype = case_when(rownames(colpheno) %in% tumor_clst1 ~ 'T1',
                                     rownames(colpheno) %in% tumor_clst2 ~ 'T2',
                                     rownames(colpheno) %in% tumor_clst3 ~ 'T3',
                                 TRUE ~ 'Others'))
# long format
save_path = paste0(output_path, '/GeoMx_tumor_heatmap_long_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colPhenoColorMaps = c(T1T2T3_colors,tstage_colors,fibrosis_colors),
                   rowDendroPlot=T,rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   gex=0.2,
                   heatmapAutoZlimMethod='range',
                   heatmapColorRampGamma=3)


##### vessel only #####
meta_here <- meta %>% filter(Tissue_Type=='Vessel') %>% filter(Sample_ID_short %in% matching_aoi$Vessel)

cts_here <- cts[,colnames(cts) %in% meta_here$Sample_ID_short]
cts_here <- t(scale(t(log2(cts_here)), scale = F)) # log transform, center by gene, keep variance

topGenes <- 100
clst<-bswClst.clust(cts_here,topNSdRows=topGenes, medianPolish = T, clusterRows = T, clusterCols = T)

# cut tree
cto <- bswClst.cutree2(clst$dc, k = 2)

vessel_clst1 <- cto$leaveLabs[[1]]
vessel_clst2 <- cto$leaveLabs[[2]]
colpheno<-data.frame(meta_here %>%  dplyr::select(tstage, fibrosis,
                                                  etiology),
                     row.names=meta_here$Sample_ID_short)
colpheno <- colpheno %>% 
  mutate(subtype = case_when(rownames(colpheno) %in% vessel_clst1 ~ 'V1',
                                     rownames(colpheno) %in% vessel_clst2 ~ 'V2',
                                 TRUE ~ 'Others'))


# short format
save_path = paste0(output_path, '/GeoMx_vessel_heatmap_short_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colNamesTopJust=F,colNamesTopPlot=F,colPhenoColorMaps = tissue_colors,
                   # rowPheno=rowPheno,rowDendroPlot=T,rowNamesLeftJust=F,rowNamesLeftPlot=F,rowPhenoColorMaps = Hoshida_colors,
                   heatmapHeight='golden',
                   heatmapAutoZlimMethod='range',
                   legendGex=4,fontsize = 15,legendIndent = 0, legendOffset=0.3,
                   heatmapColorRampGamma=5,heatmapRampGex=3
                   )

# long format
save_path = paste0(output_path, '/GeoMx_vessel_heatmap_long_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   colPheno=colpheno,colDendroPlot=T,colNamesTopJust=F,colNamesTopPlot=F,colPhenoColorMaps = c(V1V2_colors,tissue_colors),
                   # rowPheno=rowPheno,rowDendroPlot=T,rowPhenoColorMaps = Hoshida_colors,
                   rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   legendGex=4,fontsize = 15,legendIndent = 0, legendOffset=0.3,
                   heatmapAutoZlimMethod='range',heatmapRampGex=3,
                   heatmapColorRampGamma=5)
```


### find tumor and vessel AOI subtype representative genes
```{r}
# dea among T1, T2, T3
df<- Tum
de <- data.frame(matching_aoi %>% mutate(Niche = case_when(Tumor %in% tumor_clst1 ~ 'T1',
                                                Tumor %in% tumor_clst2 ~ 'T2',
                                                Tumor %in% tumor_clst3 ~ 'T3'
                                                )) %>% 
  ungroup() %>% 
  filter(!is.na(Niche)) %>% 
  dplyr::select(Tumor, Niche))
rownames(de) <- de$Tumor
df <- df[,colnames(df) %in% rownames(de)]
de <- de[match(colnames(df), rownames(de)),]
df <- df[,match(rownames(de),colnames(df))]

colnames(df) == rownames(de)# double check
dea<-get_diffexp(df,de,'Wilcoxon')  

LFC_thres <- 1

clust1_Tum_genes_all <- dea %>% filter(padj_T1_T2 < 0.05 & LFC_T1_T2 > LFC_thres | padj_T1_T3 < 0.05 & LFC_T1_T3 > LFC_thres) %>% rownames()
clust2_Tum_genes_all <- dea %>% filter(padj_T1_T2 < 0.05 & LFC_T1_T2 < -LFC_thres | padj_T2_T3 < 0.05 & LFC_T2_T3 > LFC_thres) %>% rownames()
clust3_Tum_genes_all <- dea %>% filter(padj_T1_T3 < 0.05 & LFC_T1_T3 < -LFC_thres | padj_T2_T3 < 0.05 & LFC_T2_T3 < -LFC_thres) %>% rownames()
# remove if element exists in another list
clust1_Tum_genes <- setdiff(setdiff(clust1_Tum_genes_all, clust2_Tum_genes_all),clust3_Tum_genes_all)
clust2_Tum_genes <- setdiff(setdiff(clust2_Tum_genes_all, clust1_Tum_genes_all),clust3_Tum_genes_all)
clust3_Tum_genes <- setdiff(setdiff(clust3_Tum_genes_all, clust1_Tum_genes_all),clust2_Tum_genes_all)

##### heatmap of just the T1T2T3 genes and corresponding AOIs ##### 
meta_here <- meta %>% filter(Tissue_Type=='Tumor')
colpheno<-data.frame(meta_here %>%  dplyr::select(etiology, tstage, 
                                                  # 'slide name', Pool,# sanity check ones
                                                  fibrosis), row.names=meta_here$Sample_ID_short)
colpheno <- colpheno %>% 
  mutate(subtype = case_when(rownames(colpheno) %in% tumor_clst1 ~ 'T1',
                                     rownames(colpheno) %in% tumor_clst2 ~ 'T2',
                                     rownames(colpheno) %in% tumor_clst3 ~ 'T3',
                                 TRUE ~ 'Others'))
rowPheno<-data.frame('subtype' = 
                       case_when(rownames(cts) %in% clust1_Tum_genes ~ 'T1',
                                 rownames(cts) %in% clust2_Tum_genes ~ 'T2',
                                 rownames(cts) %in% clust3_Tum_genes ~ 'T3',
                                 TRUE ~ 'Others')) 
rownames(rowPheno) <- rownames(cts)
rowPheno <- rowPheno %>% filter(subtype!='Others') %>% arrange(subtype)
cts_here <- cts[rownames(cts) %in% c(clust1_Tum_genes,clust2_Tum_genes,clust3_Tum_genes),] # keep only T1T2T3 genes
cts_here <- cts_here[,colnames(cts_here) %in% meta_here$Sample_ID_short] # keep only samples in meta
cts_here <- t(scale(t(log2(cts_here)), scale = F)) # normalize by gene
cts_here <- cts_here[match(rownames(rowPheno), rownames(cts_here)), match(c(tumor_clst1,tumor_clst2,tumor_clst3), colnames(cts_here))] # order by AOIs that define T1T2T3

clst<-bswClst.clust(cts_here,medianPolish = F, clusterRows = F, clusterCols = F)
save_path = paste0(output_path, '/GeoMx_tumor_heatmap_T1T2T3.pdf')
bswClst.plotToFile(path=save_path,clst=clst,colPheno=colpheno,
                   rowPheno=rowPheno,
                   rowDendroPlot=T,colDendroPlot=T,
                   rowPhenoColorMaps = T1T2T3_colors,
                   colPhenoColorMaps = c(tstage_colors,fibrosis_colors,T1T2T3_colors),
                   rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   gex=0.2,
                   heatmapAutoZlimMethod='range',
                   heatmapColorRampGamma=5)

##### volcano plot #####
diffexp <- dea %>% mutate(delabel = case_when((padj_T1_T2 < 0.05 & LFC_T1_T2 < -LFC_thres) ~ 'T2',
                                                  (padj_T1_T2 < 0.05 & LFC_T1_T2 > LFC_thres) ~ 'T1',
                                                  TRUE ~ 'Neither'))
diffexp$lbl<-NA
diffexp$lbl[diffexp$delabel != 'Neither']<-rownames(diffexp)[diffexp$delabel != 'Neither']
write.csv(diffexp, paste0(output_path,'/dea_T1_T2.csv'))
pdf(paste0(output_path,'/Niche_Comp_Volcano.pdf'))
tmp<-ggplot(data=diffexp,aes(x=LFC_T1_T2,y=-log10(padj_T1_T2),col=delabel, label=lbl)) +
  geom_point() + theme_classic() +geom_text_repel() +
  scale_color_manual('subtype',values=T1T2T3_colors$subtype) +
  labs(title='T1 vs T2 AOIs ',
       x = bquote(log[2]('T1/T2')),
       y = bquote(-log[10]('adjusted p-value'))) +
  geom_vline(xintercept=c(-LFC_thres,LFC_thres), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray") +
  guides(color = guide_legend(override.aes = list(size = 3,shape=19)))+
  theme(axis.text=element_text(size=15),
      axis.title=element_text(size=15),
      legend.title = element_text(size=15),
      legend.text = element_text(size=15))

print(tmp)

# T1 vs T3
myCol=c(T1T2T3_colors$subtype['T1'],T1T2T3_colors$subtype['T3'],'grey')
names(myCol)<-c('T1','T3','Neither')

diffexp <- dea %>% mutate(delabel = case_when((padj_T1_T3< 0.05 & LFC_T1_T3 < -LFC_thres) ~ 'T3',
                                                  (padj_T1_T3< 0.05 & LFC_T1_T3 > LFC_thres) ~ 'T1',
                                                  TRUE ~ 'Neither'))
diffexp$lbl<-NA
diffexp$lbl[diffexp$delabel != 'Neither']<-rownames(diffexp)[diffexp$delabel != 'Neither']
# write.csv(diffexp, paste0(output_path,'/dea_T1_T3.csv'))
tmp<-ggplot(data=diffexp,aes(x=LFC_T1_T3,y=-log10(padj_T1_T3),col=delabel, label=lbl)) +
  geom_point() + theme_classic() +geom_text_repel() +
  scale_color_manual('subtype',values=T1T2T3_colors$subtype) +
  labs(title='T1 vs T3 AOIs ', 
      x = bquote(log[2]('T1/T3')),
      y = bquote(-log[10]('adjusted p-value'))) + 
  geom_vline(xintercept=c(-LFC_thres,LFC_thres), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray")+
  guides(color = guide_legend(override.aes = list(size = 3, shape=19)))+
  theme(axis.text=element_text(size=15),
      axis.title=element_text(size=15),
      legend.title = element_text(size=15),
      legend.text = element_text(size=15))
print(tmp)

# T2 vs T3
myCol=c(T1T2T3_colors$subtype['T2'],T1T2T3_colors$subtype['T3'],'grey')
names(myCol)<-c('T2','T3','Neither')

diffexp <- dea %>% mutate(delabel = case_when((padj_T2_T3< 0.05 & LFC_T2_T3 < -LFC_thres) ~ 'T3',
                                                  (padj_T2_T3< 0.05 & LFC_T2_T3 > LFC_thres) ~ 'T2',
                                                  TRUE ~ 'Neither'))
diffexp$lbl<-NA
diffexp$lbl[diffexp$delabel != 'Neither']<-rownames(diffexp)[diffexp$delabel != 'Neither']
write.csv(diffexp, paste0(output_path,'/dea_T2_T3.csv'))
tmp<-ggplot(data=diffexp,aes(x=LFC_T2_T3,y=-log10(padj_T2_T3),col=delabel, label=lbl)) +
  geom_point() + theme_classic() +geom_text_repel() +
  scale_color_manual('subtype',values=T1T2T3_colors$subtype) +
  labs(title='T2 vs T3 AOIs ',
      x = bquote(log[2]('T2/T3')),
      y = bquote(-log[10]('adjusted p-value'))) +
  geom_vline(xintercept=c(-LFC_thres,LFC_thres), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray")+
  guides(color = guide_legend(override.aes = list(size = 3, shape=19)))+
  theme(axis.text=element_text(size=15),
      axis.title=element_text(size=15),
      legend.title = element_text(size=15),
      legend.text = element_text(size=15))
print(tmp)
dev.off()
```

# survival correlation
### tumor subtypes
```{r}
meta_here <- meta %>% filter(Tissue_Type == 'Tumor') %>%
  mutate(subtype = case_when(Sample_ID_short %in% tumor_clst1 ~ 'T1',
                             Sample_ID_short %in% tumor_clst2 ~ 'T2',
                             Sample_ID_short %in% tumor_clst3 ~ 'T3',
                                 TRUE ~ 'Others')) %>%
  filter(subtype != 'Others')

res <- coxph(Surv(time, status) ~ subtype, data = meta_here)
pdf(paste0(output_path,'/GeoMx_survival.pdf'))
print(ggsurvplot(survfit(Surv(time, status) ~ subtype, data = meta_here), pval=TRUE, risk.table = TRUE, palette = unname(T1T2T3_colors$subtype[1:3]),xlab='Time (days)'))
dev.off()
```

### vessel subtypes 
```{r}
# dea between V1 and V2
df<- Ves
de <- data.frame(matching_aoi %>% mutate(Niche = case_when(Vessel %in% vessel_clst1 ~ 'V1',
                                                Vessel %in% vessel_clst2 ~ 'V2',
                                                )) %>% 
  ungroup() %>% 
  filter(!is.na(Niche)) %>% 
  dplyr::select(Vessel, Niche))
rownames(de) <- de$Vessel
df <- df[,colnames(df) %in% rownames(de)]
de <- de[match(colnames(df), rownames(de)),]
df <- df[,match(rownames(de),colnames(df))]

colnames(df) == rownames(de)# double check
dea<-get_diffexp(df,de,'Wilcoxon')  

LFC_thres <- 1

clust1_Ves_genes <- dea %>% filter(padj_V1_V2 < 0.05 & LFC_V1_V2 > LFC_thres) %>% rownames()
clust2_Ves_genes <- dea %>% filter(padj_V1_V2 < 0.05 & LFC_V1_V2 < -LFC_thres) %>% rownames()

meta_here <- meta %>% filter(Tissue_Type == 'Vessel') %>%
  mutate(subtype = case_when(Sample_ID_short %in% vessel_clst1 ~ 'V1',
                             Sample_ID_short %in% vessel_clst2 ~ 'V2',
                                 TRUE ~ 'Others')) %>%
  filter(subtype != 'Others')

res <- coxph(Surv(time, status) ~ subtype, data = meta_here) 
pdf(paste0(output_path,'/GeoMx_Ves_survival.pdf'))
print(ggsurvplot(survfit(Surv(time, status) ~ subtype, data = meta_here), pval=TRUE, risk.table = TRUE, palette = unname(V1V2_colors$subtype[1:2])))
dev.off()
```

### correlate ROI Hoshida types with vascularization 
```{r}
S1_genes_in_cts <- intersect(HoshidaGenes$Genes[HoshidaGenes$Set==1],rownames(cts))
S2_genes_in_cts <- intersect(HoshidaGenes$Genes[HoshidaGenes$Set==2],rownames(cts))
S3_genes_in_cts <- intersect(HoshidaGenes$Genes[HoshidaGenes$Set==3],rownames(cts))
raw_cts <- read.delim(paste0(data_path,'/rawCounts.tsv')) # generated using NS workflow script

# shorten sample names
colnames(raw_cts) <- gsub('\\.','-',colnames(raw_cts))
colnames(raw_cts) <- gsub('.dcc','',colnames(raw_cts))
colnames(raw_cts) <- gsub('DSP-100166000','',colnames(raw_cts))

# these are vessel AOIs. so as to keep rownames and df structure
raw_cts_roi <- raw_cts[,c('6330-C-E05','5957-A-A03')] 

# combine counts from tumor and vessel in the same ROI to simulate bulk sequencing
for (tum in matching_aoi$Tumor){
  ves <- matching_aoi[matching_aoi$Tumor==tum,]$Vessel
  per_roi <- data.frame(rowSums(raw_cts[,c(tum, ves)]))
  colnames(per_roi) = tum
  raw_cts_roi <- cbind(raw_cts_roi, per_roi)
}

# drop the vessel AOIs now
raw_cts_roi <- raw_cts_roi[,!names(raw_cts_roi) %in% c('6330-C-E05','5957-A-A03')]

# log and mean center quantile normalized data -> each gene has mean 0
raw_cts_roi_centered <- t(scale(log(t(raw_cts_roi+1)), center = T, scale = F))

Hoshida_dominant <- data.frame(matrix(ncol = 2, nrow = 1))
colnames(Hoshida_dominant) <-c('Tumor','Hoshida_type')

for (tum_AOI in colnames(raw_cts_roi)){
  S1_ratio <- mean(raw_cts_roi_centered[rownames(raw_cts_roi_centered) %in% S1_genes_in_cts,tum_AOI])
  S2_ratio <- mean(raw_cts_roi_centered[rownames(raw_cts_roi_centered) %in% S2_genes_in_cts,tum_AOI])
  S3_ratio <- mean(raw_cts_roi_centered[rownames(raw_cts_roi_centered) %in% S3_genes_in_cts,tum_AOI])
  Hoshida_dominant <- rbind(Hoshida_dominant, c(tum_AOI, paste0('S',which.max(c(S1_ratio,S2_ratio,S3_ratio)))))
}

Hoshida_dominant <- Hoshida_dominant[2:nrow(Hoshida_dominant),]

Hoshida_dominant %>% group_by(Hoshida_type) %>% tally() # by ROI

##### plot relationship between S1/S2/S3 and vascularization #####
AOI_areas <- meta %>% dplyr::select(Sample_ID_short, area)
vascularization <- merge(AOI_areas, matching_aoi[c('Tumor','Vessel')], by.x = 'Sample_ID_short', by.y='Tumor')
colnames(vascularization) <- c('Tumor','Tumor_area','Vessel')
vascularization <- merge(AOI_areas, vascularization, by.x = 'Sample_ID_short', by.y = 'Vessel')
colnames(vascularization) <- c('Vessel','Vessel_area','Tumor','Tumor_area')
vascularization <- vascularization %>% mutate(ves_perc = 100* Vessel_area/ (Vessel_area+Tumor_area))

# vascularization <- merge(Hoshida_dominant, vascularization, by = c('Tumor','Vessel'))
vascularization <- merge(Hoshida_dominant, vascularization, by = c('Tumor'))
vascularization <- merge(vascularization, meta[c('Sample_ID_short','ID')], by.x = 'Tumor', by.y='Sample_ID_short')

# pdf(paste0(output_path,'/GeoMx_vasc_Hoshida.pdf'))
my_comparisons <- list( c("S1", "S2"), c("S2", "S3"), c("S1", "S3"))
vascularization %>%
  ggplot(aes(fill=Hoshida_type, y=ves_perc, x=Hoshida_type)) + 
    geom_boxplot(position="dodge", width=0.5, alpha=0.7) +
    theme_classic()+
    scale_fill_manual(values=Hoshida_colors$Hoshida_type[1:3])+
    xlab("Hoshida type for ROIs") +
    ylab("Vessel area percentage (%)") + 
    theme(axis.text=element_text(size=20),
          axis.title=element_text(size=20),
          legend.position='none')+
    stat_compare_means(comparisons = my_comparisons,size = 8)  # Add pairwise comparisons p-value

# within patient heterogeneity
ggplot(vascularization, aes(fill=Hoshida_type, y=ves_perc, x=ID)) +
    geom_bar(position="dodge", stat="identity", alpha = 0.5) +
    scale_fill_manual(values = c('black','blue','green'), name = "ROI Hoshida type") +
    ylab("vessel area percentage (%)")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    theme_classic()+ 
    guides(legend.position="bottom")
# dev.off()
```

# scAtlasLC
### load data 
```{r}
scAtlasLC_pwd <- paste0(data_path,'/scAtlasLC/')
scAtlasLC <- ReadMtx(mtx=paste0(scAtlasLC_pwd, 'matrix.mtx.gz'), 
                     cells = paste0(scAtlasLC_pwd, 'barcodes.tsv.gz'),
                     features = paste0(scAtlasLC_pwd, 'features.tsv.gz')) 
sparsity <- length(scAtlasLC@x) / scAtlasLC@Dim[1] / scAtlasLC@Dim[2]

scAtlasLC_info <- read.csv(paste0(scAtlasLC_pwd,'GSE151530_Info.txt'), sep = '\t') 

genes_overlap <- intersect(rownames(scAtlasLC), HoshidaGenes$Genes)

HCC_TECs_scAtlas <- scAtlasLC_info %>% 
  filter(Type == 'TECs') %>% 
  filter(str_detect(Sample, "H")) 

HCC_cancer_scAtlas <- scAtlasLC_info %>% 
  filter(Type == 'Malignant cells') %>% 
  filter(str_detect(Sample, "H"))

HCC_TECs_cts <- scAtlasLC[,colnames(scAtlasLC) %in% HCC_TECs_scAtlas$Cell] %>% as.data.frame() %>% 
  rownames_to_column('Gene')

HCC_cancer_scAtlas_cts <- scAtlasLC[,colnames(scAtlasLC) %in% HCC_cancer_scAtlas$Cell] %>% as.data.frame() %>% 
  rownames_to_column('Gene')

# for each sample, sum up the counts across tumor cells and also across TECs
cts_sc2bulk <- data.frame(row.names = HCC_cancer_scAtlas_cts$Gene)
for(sample in unique(HCC_cancer_scAtlas$Sample)){
  print(sample)
  cell_IDs <- HCC_cancer_scAtlas[HCC_cancer_scAtlas$Sample==sample,]$Cell
  cts_here <- rowSums(HCC_cancer_scAtlas_cts[,colnames(HCC_cancer_scAtlas_cts) %in% cell_IDs])
  cts_here_bulk <- data.frame(cts_here, row.names = HCC_cancer_scAtlas_cts$Gene)
  colnames(cts_here_bulk) <- paste0(sample,'_tumor')
  cts_sc2bulk <- cbind(cts_sc2bulk,cts_here_bulk)
}

for(sample in unique(HCC_TECs_scAtlas$Sample)){
  print(sample)
  cell_IDs <- HCC_TECs_scAtlas[HCC_TECs_scAtlas$Sample==sample,]$Cell
  cts_here <- rowSums(data.frame(HCC_TECs_cts[,colnames(HCC_TECs_cts) %in% cell_IDs]))
  cts_here_bulk <- data.frame(cts_here, row.names = HCC_TECs_cts$Gene)
  colnames(cts_here_bulk) <- paste0(sample,'_TECs')
  cts_sc2bulk <- cbind(cts_sc2bulk,cts_here_bulk)
}

# clear up memory
remove(scAtlasLC)
cts_sc2bulk <- cts_sc2bulk + 1 # to avoid numerical overflow issues. only do this once! 
```
### scAtlasLC heatmap

```{r}
cell_colors <- list('Cell Type'=c('tumor'='forestgreen','TECs'='red'))
colPheno<-data.frame(sub("^[^_]*_", "", colnames(cts_sc2bulk)),
                     row.names=colnames(cts_sc2bulk))
colnames(colPheno) <- 'Cell Type'
rownames(colPheno)
rowPheno<-cts_sc2bulk %>% 
  mutate(Gene = rownames(cts_sc2bulk)) %>% 
  mutate('Hoshida_type' = case_when(Gene %in% HoshidaGenes[HoshidaGenes$Set=='1',]$Genes ~ 'S1',
                                 Gene %in% HoshidaGenes[HoshidaGenes$Set=='2',]$Genes ~ 'S2',
                                 Gene %in% HoshidaGenes[HoshidaGenes$Set=='3',]$Genes ~ 'S3',
                                 TRUE ~ 'Others'))%>%  
  dplyr::select(Hoshida_type)

rowPheno %>% group_by(Hoshida_type) %>% tally()

cts_here <- scale(log2(cts_sc2bulk), scale = F) # center by sample first
cts_here <- t(scale(t(cts_here), scale = F))# center by gene second

topGenes <- 500
clst<-bswClst.clust(cts_here,topNSdRows=topGenes, medianPolish = F, clusterRows = T, clusterCols = T)

# short format
save_path = paste0(output_path, '/scAtlas_heatmap_short_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,
                   clst=clst,
                   rowPheno=rowPheno,rowPhenoColorMaps = Hoshida_colors,rowDendroPlot=T,colDendroPlot=T,rowNamesLeftPlot=F,rowNamesRightPlot=F,
                   colPheno=colPheno,colPhenoColorMaps = cell_colors,colNamesTopPlot=F,
                   heatmapHeight='golden',
                   heatmapAutoZlimMethod='range',
                   heatmapRampOffset = -1,
                   heatmapColorRampGamma=5,
                   legendOffset=0.1,legendGex=2)
 
# long format
save_path = paste0(output_path, '/scAtlas_heatmap_long_top',topGenes,'.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   rowPheno=rowPheno,rowDendroPlot=T,
                   rowPhenoColorMaps = Hoshida_colors,
                   rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   colPheno=colPheno,colDendroPlot=T,colPhenoColorMaps = cell_colors,colNamesTopPlot=F,
                   gex=0.2,
                   heatmapAutoZlimMethod='range',
                   heatmapRampOffset = -1,heatmapColorRampGamma=5,legendGex=1)

# only Hoshida genes
rowPheno_Hoshida <- rowPheno %>% filter(Hoshida_type!='Others')
cts_here <- cts_here[rownames(cts_here)%in% rownames(rowPheno_Hoshida),] 

clst<-bswClst.clust(cts_here,topNSdRows=600, medianPolish = F, clusterRows = T, clusterCols = T)
# short format
save_path = paste0(output_path, '/scAtlas_heatmap_Hoshida.pdf')
bswClst.plotToFile(path=save_path,
                   clst=clst,
                   rowPheno=rowPheno,rowPhenoColorMaps = Hoshida_colors,rowDendroPlot=T,colDendroPlot=T,rowNamesLeftPlot=F,rowNamesRightPlot=F,
                   colPheno=colPheno,colPhenoColorMaps = cell_colors,colNamesTopPlot=F,
                   heatmapHeight='golden',
                   heatmapRampOffset = -1,heatmapAutoZlimMethod='range',
                   heatmapColorRampGamma=5)
# long format
save_path = paste0(output_path, '/scAtlas_heatmap_Hoshida_long.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   rowPheno=rowPheno,rowPhenoColorMaps = Hoshida_colors,rowDendroPlot=T,colDendroPlot=T,rowNamesLeftPlot=F,rowNamesRightPlot=F,
                   colPheno=colPheno,colPhenoColorMaps = cell_colors,colNamesTopPlot=F,
                   gex=0.2,
                   heatmapAutoZlimMethod='range',
                   heatmapColorRampGamma=5)

# only T1T2T3 genes
rowPheno_T1T2T3 <- rowPheno %>% 
  mutate(gene_name = rownames(rowPheno))%>%
  # rownames_to_column('gene_name') %>%
  mutate(gene_type = case_when(gene_name%in%clust1_Tum_genes~'T1',
                               gene_name%in%clust2_Tum_genes~'T2',
                               gene_name%in%clust3_Tum_genes~'T3',
                               TRUE ~ 'Others')) %>%
  filter(gene_type != 'Others') %>%
  dplyr::select(gene_type) 
cts_here <- cts_here[rownames(cts_here)%in% rownames(rowPheno_T1T2T3),] 
cts_here <- cts_here[,grepl("tumor", colnames(cts_here))]# only tumor samples

clst<-bswClst.clust(cts_here,topNSdRows=600, medianPolish = F, clusterRows = T, clusterCols = T)
# # short format
# save_path = paste0(output_path, '/scAtlas_heatmap_T1T2T3.pdf')
# bswClst.plotToFile(path=save_path,
#                    clst=clst,
#                    rowPheno=rowPheno_T1T2T3,rowPhenoColorMaps = T1T2T3_colors,rowDendroPlot=T,colDendroPlot=T,rowNamesLeftPlot=T,rowNamesRightPlot=T,
#                    colPheno=colPheno,colPhenoColorMaps = cell_colors,colNamesTopPlot=T,
#                    heatmapHeight='golden',
#                    heatmapRampOffset = -1,heatmapAutoZlimMethod='range',
#                    heatmapColorRampGamma=5)
# long format
save_path = paste0(output_path, '/scAtlas_heatmap_T1T2T3_long.pdf')
bswClst.plotToFile(path=save_path,clst=clst,
                   rowPheno=rowPheno_T1T2T3,rowPhenoColorMaps = T1T2T3_colors,rowDendroPlot=T,colDendroPlot=T,rowNamesLeftPlot=T,rowNamesRightPlot=T,
                   colPheno=colPheno,colPhenoColorMaps = cell_colors,colNamesTopPlot=T,
                   gex=0.2,
                   heatmapAutoZlimMethod='range',
                   heatmapColorRampGamma=5)
```
### scAtlasLC DEA 
```{r}
##### volcano plots to compare between tumor and vessel cells #####
# quantile normalization. ref: https://davetang.org/muse/2014/07/07/quantile-normalisation-in-r/ 
quantile_normalisation <- function(df){
  df_rank <- apply(df,2,rank,ties.method="min")
  df_sorted <- data.frame(apply(df, 2, sort))
  df_mean <- apply(df_sorted, 1, mean)
   
  index_to_mean <- function(my_index, my_mean){
    return(my_mean[my_index])
  }
   
  df_final <- apply(df_rank, 2, index_to_mean, my_mean=df_mean)
  rownames(df_final) <- rownames(df)
  return(df_final)
}
 
cts_here <- quantile_normalisation(cts_sc2bulk)

df<- cts_here # normalized counts table
de <- data.frame(sample=colnames(cts_here)) %>% 
  mutate(cell_type = case_when(str_detect(sample,'tumor')~'tumor',
                               str_detect(sample,'TECs')~'TECs',
                               TRUE~''))
rownames(de) <- de$sample

# # rename sample column to be compatible with get_diffexp function
df <- df[,colnames(df) %in% rownames(de)]
de <- de[match(colnames(df), rownames(de)),]
df <- df[,match(rownames(de),colnames(df))]

colnames(df) == rownames(de)# double check

dea<-get_diffexp(df,de,'Wilcoxon')

# plot
diffexp <- dea %>% mutate(delabel = case_when((padj_TECs_tumor < 0.05 & LFC_TECs_tumor > 1) ~ 'Vessel',
                                                  (padj_TECs_tumor < 0.05 & LFC_TECs_tumor < -1) ~ 'Tumor',
                                                  TRUE ~ 'Neither'))
diffexp$lbl<-NA
diffexp$lbl[diffexp$delabel != 'Neither']<-rownames(diffexp)[diffexp$delabel != 'Neither']

diffexp <- diffexp %>% mutate(Hoshida_gene_set = case_when((rownames(dea) %in% HoshidaGenes[HoshidaGenes$Set=='1',]$Genes) ~ 'S1',
                                              (rownames(dea) %in% HoshidaGenes[HoshidaGenes$Set=='2',]$Genes) ~ 'S2',
                                              (rownames(dea) %in% HoshidaGenes[HoshidaGenes$Set=='3',]$Genes) ~ 'S3',
                                              TRUE ~ 'Others'))
diffexp$lbl<-NA
diffexp$lbl[diffexp$Hoshida_gene_set != 'Others']<-rownames(diffexp)[diffexp$Hoshida_gene_set != 'Others']

write.csv(diffexp, paste0(output_path,'/scAtlas_Tum_vs_Vessel_dea.csv'))
pdf(paste0(output_path,'/scAtlas_Tum_vs_Vessel_dea_Hoshida_color.pdf'))
# reverse the LFC to be consistent with heatmap - purely visualization purposes
tmp<-ggplot(data=diffexp,aes(x=-LFC_TECs_tumor,y=-log10(padj_TECs_tumor),col=Hoshida_gene_set, label=lbl, size=Hoshida_gene_set)) +
  geom_point() + 
  scale_color_manual('Hoshida set',values=c('S1'='black','S2'='dodgerblue3','S3'='forestgreen','Others'='gray'))+
  scale_size_manual('Hoshida set',values=c('S1'=2,'S2'=2,'S3'=2,'Others'=1)) +
  scale_alpha_manual('Hoshida set',values=c('S1'=1,'S2'=1,'S3'=1,'Others'=0.1)) +
  theme_classic() +
  geom_label_repel(size = 2, min.segment.length = 0, max.overlaps = 11,
                  show.legend = FALSE) +
  xlab(bquote(log[2]("tumor/vessel")))+
  ylab(bquote(-log[10]("adjusted p-value")))+
  geom_vline(xintercept=c(-1,1), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray") +
  guides(color = guide_legend(override.aes = list(size = 3)))+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=18),
        legend.title = element_text(size=18),
        legend.text = element_text(size=18),
        legend.position = 'bottom')

print(tmp)
dev.off()

# get counts 
diffexp %>% filter(Hoshida_gene_set=='S1') %>% group_by(delabel) %>% tally()
diffexp %>% filter(Hoshida_gene_set=='S2') %>% group_by(delabel) %>% tally()
diffexp %>% filter(Hoshida_gene_set=='S3') %>% group_by(delabel) %>% tally()
```

### TCGA correlation
```{r}
library(gtsummary)
##### merge datasets ##### 
# patient clinical info
TCGA_pt <- read.delim(paste0(data_path,"/TCGA/lihc_tcga_pan_can_atlas_2018/data_clinical_patient.txt"), skip=4, sep="\t") %>% 
  dplyr::select(PATIENT_ID,AGE,SEX,DAYS_LAST_FOLLOWUP,DAYS_TO_BIRTH,OS_STATUS,OS_MONTHS,DSS_STATUS,DSS_MONTHS,DFS_STATUS,DFS_MONTHS,PFS_STATUS,PFS_MONTHS)
row.names(TCGA_pt) <- TCGA_pt$PATIENT_ID 
TCGA_pt <- TCGA_pt[, -1]

# gene
TCGA_genes <- read.delim(paste0(data_path,"/TCGA/lihc_tcga_pan_can_atlas_2018/data_mrna_seq_v2_rsem_zscores_ref_all_samples.txt")) %>% 
  dplyr::select(-Entrez_Gene_Id) %>%
  filter(Hugo_Symbol!="")
# remove duplicate genes (not sure what to make of them - prob not important)
# dup_genes <- TCGA_genes$Hugo_Symbol[duplicated(TCGA_genes$Hugo_Symbol)]
TCGA_genes <- TCGA_genes[!duplicated(TCGA_genes$Hugo_Symbol), ]
row.names(TCGA_genes) <- TCGA_genes$Hugo_Symbol 
TCGA_genes <- TCGA_genes[, -1]

# remove extra strings
colnames(TCGA_genes)<- gsub('.01','',colnames(TCGA_genes))
# replace all . with -
colnames(TCGA_genes) <- gsub('\\.','-',colnames(TCGA_genes))

# combine the two dataframes
TCGA_df <- merge(TCGA_pt, t(TCGA_genes), by = "row.names")

# remove cases with NA OS_MONTHS or OS_STATUS
TCGA_df <- TCGA_df %>% 
  filter(!is.na(OS_MONTHS)) %>% 
  filter(!is.na(OS_STATUS))
  
##### survival correlations #####
hist(TCGA_df$CXCL2)
plot(TCGA_df$OS_MONTHS, TCGA_df$CXCL2)

library(survival)
library(survminer)
# gene <- "CXCL2"
# surv_res_df <- data.frame(gene=rownames(TCGA_genes),HR=numeric(nrow(TCGA_genes)),pval=numeric(nrow(TCGA_genes)))
surv_res_df <- data.frame(gene=character(0),HR=numeric(0),pval=numeric(0))

# for(gene_name in c("CXCL2","CXCL12","APOA2")){
for(gene_name in rownames(TCGA_genes)){
  # print(gene_name)
  time <- TCGA_df$OS_MONTHS
  status <- ifelse(TCGA_df$OS_STATUS=="1:DECEASED",1,0)
  median_value <- median(TCGA_df[,gene_name])
  if(length(unique(TCGA_df[,gene_name]))>1){
    gene_level <- cut(TCGA_df[,gene_name], breaks = c(-Inf, median_value, Inf), labels = c("Low", "High"), include.lowest = TRUE)

  temp_df <- data.frame(time=time,status=status,gene_level = gene_level)
  # Create a survival object
  # surv_obj <- survfit(Surv(time, status) ~ gene_level, data=temp_df) 
  # str(surv_obj)
  res <- coxph(Surv(time, status) ~ gene_level, data = temp_df) 
  HR <- exp(summary(res)$coefficients[1])
  pval <- summary(res)$coefficients[5]
  # surv_res_df <- rbind(surv_res_df, c(gene_name,HR,pval))
  surv_res_df[nrow(surv_res_df)+1, ] <- c(gene_name,HR,pval)
  # surv_res_df[1:num_rows_to_append, ] <- c(gene_name,HR,pval)

  # Plot the Kaplan-Meier curve
  # print(ggsurvplot(surv_obj, pval = TRUE, conf.int = TRUE, risk.table = TRUE, risk.table.col = "strata"))
  }
}

# plot volcano plot 
surv_res_df <- surv_res_df %>% mutate(gene_set = case_when(gene %in% clust1_Tum_genes ~ 'T1',
                                                gene %in% clust2_Tum_genes ~ 'T2',
                                                gene %in% clust3_Tum_genes ~ 'T3',
                                                TRUE ~ '')) %>% 
  mutate(lbl = case_when(
    as.numeric(pval)<0.05 & HR>1.33 & gene_set != ''~ gene,
                       as.numeric(pval)<0.05 & HR<0.75 & gene_set!= '' ~ gene,
                        # gene_set != '' ~ gene,
                        TRUE~'')) 
  
tmp<-ggplot(data=surv_res_df,aes(x=log10(as.numeric(HR)),y=-log10(as.numeric(pval)), label=lbl, color=gene_set, alpha=lbl)) +
  geom_point() +geom_label_repel(show.legend  = F, max.overlaps = Inf,) +
  xlab("log10(HR (high vs low))")+
  ylab("-log10(p-value)")+
  scale_color_manual('subtype',values=T1T2T3_colors$subtype) +
  scale_alpha_manual(values=c('T1'=1,'T2'=1,'T3'=1,'Others'=0.1))+
  scale_size_manual(values=c('T1'=10,'T2'=10,'T3'=10,'Others'=0.05))+
  xlim(c(-1,1))+ylim(c(0,6))+
  theme_classic()+
  # theme_classic(base_size = 16)+
  geom_vline(xintercept=c(log10(0.75),log10(1.33)), linetype = "longdash",col="gray") +
  geom_hline(yintercept=-log10(.05), linetype = "longdash",col="gray")+
  theme(axis.text=element_text(size=15),
      axis.title=element_text(size=15),
      legend.title = element_text(size=20),
      legend.text = element_text(size=20))
pdf(paste0(output_path,'/TCGA_survival.pdf'))
print(tmp)
dev.off()

# show a few examples
gene_name <- 'ENG'
time <- TCGA_df$OS_MONTHS
status <- ifelse(TCGA_df$OS_STATUS=="1:DECEASED",1,0)
median_value <- median(TCGA_df[,gene_name])
gene_level <- cut(TCGA_df[,gene_name], breaks = c(-Inf, median_value, Inf), labels = c("Low", "High"), include.lowest = TRUE)
temp_df <- data.frame(time=time,status=status,gene_level = gene_level)
# Create a survival object
surv_obj <- survfit(Surv(time, status) ~ gene_level, data=temp_df)

# Plot the Kaplan-Meier curve
print(ggsurvplot(surv_obj, pval = TRUE, conf.int = TRUE, risk.table = TRUE, risk.table.col = "strata"))
```

# L-R analysis using CellChat
```{r}
theme_set(theme_bw())
load(paste0(data_path, '/CellChat/CellChatDB.human.rda'))
Ves<-cts[,matching_aoi$Vessel]
Tum<-cts[,matching_aoi$Tumor]
LR_pairs <- CellChatDB.human$interaction[c('ligand','receptor')]
LR_pairs_small <- LR_pairs[LR_pairs$ligand %in% rownames(Tum),]# only keep the genes in GeoMx
LR_pairs_small <- LR_pairs_small[LR_pairs_small$receptor %in% rownames(Tum),]# further filtering
 
### ligand in Tumor and receptor in vessel
betas <- c()
cors <- c()
pvals <- c()
for (i in 1:nrow(LR_pairs_small)) {
  LR_pair <- LR_pairs_small[i, ]
  T_exp <- Tum[,colnames(Tum) %in% matching_aoi$Tumor]
  V_exp <- Ves[,colnames(Ves) %in% matching_aoi$Vessel]
  x <- log(as.numeric(T_exp[LR_pair$ligand,])+1)
  y <- log(as.numeric(V_exp[LR_pair$receptor,])+1)
  lm_res <- lm(y ~ x)
  beta <- coef(summary(lm_res))[2,1]
  pval <- coef(summary(lm_res))[2,4]
  cor_test <- cor.test(x,y)
  cor <- cor_test$estimate
  # pval <- cor_test$p.value    
  betas <- c(betas,beta)
  cors <- c(cors,cor)
  pvals <- c(pvals,pval)
}
LR_pairs_small$Tum_Ves_beta <- betas
LR_pairs_small$Tum_Ves_cor <- cors
LR_pairs_small$Tum_Ves_cor_pval <- pvals
# LR_pairs_small <- LR_pairs_small %>% mutate(Tum_Ves_pairs = case_when(Tum_Ves_cor_pval <0.05 ~ paste(ligand,receptor,sep = '_')))

### repeat the same analysis with ligand in vessel and receptor in tumor
betas <- c()
cors <- c()
pvals <- c()
for (i in 1:nrow(LR_pairs_small)) {
  LR_pair <- LR_pairs_small[i, ]
  x <- log(as.numeric(V_exp[LR_pair$ligand,])+1)
  y <- log(as.numeric(T_exp[LR_pair$receptor,])+1)
  lm_res <- lm(y ~ x)
  beta <- coef(summary(lm_res))[2,1]
  pval <- coef(summary(lm_res))[2,4]
  betas <- c(betas,beta)
  cors <- c(cors,cor)
  pvals <- c(pvals,pval)
}
LR_pairs_small$Ves_Tum_beta <- betas
LR_pairs_small$Ves_Tum_cor <- cors
LR_pairs_small$Ves_Tum_cor_pval <- pvals
# LR_pairs_small <- LR_pairs_small %>% mutate(Ves_Tum_pairs = case_when(Ves_Tum_cor_pval <0.05 ~ paste(ligand,receptor,sep = '_')))

# separate by T1/T2/T3 subtypes
for (i in 1:3){
  T_subtype <- get(paste0('tumor_clst',i))
  R_subtype_pairs <- matching_aoi[matching_aoi$Tumor %in% T_subtype,]
  T_exp_subtype <- Tum[,colnames(Tum) %in% R_subtype_pairs$Tumor]
  V_exp_subtype <- Ves[,colnames(Ves) %in% R_subtype_pairs$Vessel]
  betas <- c()
  cors <- c()
  pvals <- c()
  for (j in 1:nrow(LR_pairs_small)) {
    LR_pair <- LR_pairs_small[j, ]
    x <- log(as.numeric(T_exp_subtype[LR_pair$ligand,])+1)
    y <- log(as.numeric(V_exp_subtype[LR_pair$receptor,])+1)
    lm_res <- lm(y ~ x)
    beta <- coef(summary(lm_res))[2,1]
    pval <- coef(summary(lm_res))[2,4]
    cor_test <- cor.test(x,y)
    cor <- cor_test$estimate
    # pval <- cor_test$p.value
    betas <- c(betas,beta)
    cors <- c(cors,cor)
    pvals <- c(pvals,pval)
  }
  LR_pairs_small <- LR_pairs_small %>% mutate('T{i}_Tum_Ves_beta' := betas)
  LR_pairs_small <- LR_pairs_small %>% mutate('T{i}_Tum_Ves_cor' := cors)
  LR_pairs_small <- LR_pairs_small %>% mutate('T{i}_Tum_Ves_cor_pval' := pvals)

# repeat for ves_tum 
  betas <- c()
  cors <- c()
  pvals <- c()
  for (j in 1:nrow(LR_pairs_small)) {
    LR_pair <- LR_pairs_small[j, ]
    x <- log(as.numeric(V_exp_subtype[LR_pair$ligand,])+1)
    y <- log(as.numeric(T_exp_subtype[LR_pair$receptor,])+1)
    lm_res <- lm(y ~ x)
    beta <- coef(summary(lm_res))[2,1]
    pval <- coef(summary(lm_res))[2,4]
    cor_test <- cor.test(as.numeric(V_exp_subtype[LR_pair$ligand,]),as.numeric(T_exp_subtype[LR_pair$receptor,]))
    cor <- cor_test$estimate
    pval <- cor_test$p.value
    betas <- c(betas,beta)
    cors <- c(cors,cor)
    pvals <- c(pvals,pval)
  }
  LR_pairs_small <- LR_pairs_small %>% mutate('T{i}_Ves_Tum_beta' := betas)
  LR_pairs_small <- LR_pairs_small %>% mutate('T{i}_Ves_Tum_cor' := cors)
  LR_pairs_small <- LR_pairs_small %>% mutate('T{i}_Ves_Tum_cor_pval' := pvals)
}

# visualize results
pdf(paste0(output_path,'/CellChat_cor.pdf'))
color_scheme <- c("known" = "red", "novel" = "blue", "other" = "black")
pval_thres <- 0.05

LR_pairs_small %>% 
  filter(ligand != receptor) %>%
  mutate(LR_pairs = case_when(Tum_Ves_cor_pval<pval_thres ~paste0(ligand, '_',receptor))) %>%
  mutate(color = case_when(paste0(ligand,'_',receptor) %in% c('VEGFA_FLT1', 'CSF1_CSF1R')~'known',
                           paste0(ligand,'_',receptor) %in% c('LGALS9_CD44', 'LGALS9_HAVCR2', 'JAG1_NOTCH3', 'JAG1_NOTCH1', 'CD209_CEACAM1')~'novel',
                           TRUE ~ 'other')) %>%
  ggplot(aes(x=Tum_Ves_beta,y=-log10(Tum_Ves_cor_pval), label = LR_pairs, color=color)) +
  scale_color_manual(values = color_scheme) +
  geom_point() + ggrepel::geom_text_repel(max.overlaps = Inf, show.legend = FALSE)+
  labs(x="effect size: ligand in tumor ~ receptor in vessel (log scale)",
       y="-log10(p-value)")+
  theme(
    axis.title = element_text(size = 16),  # Axis title size for both x and y
    axis.text = element_text(size = 14)    # Axis text size for both x and y
  )

# LR_pairs_small %>% 
#   filter(ligand != receptor) %>%
#   mutate(LR_pairs = case_when(Tum_Ves_cor_pval<pval_thres ~paste0(ligand, '_',receptor))) %>%
#   mutate(color = case_when(paste0(ligand,'_',receptor) %in% c('VEGFA_FLT1', 'CSF1_CSF1R')~'known',
#                            paste0(ligand,'_',receptor) %in% c('LGALS9_CD44', 'LGALS9_HAVCR2', 'JAG1_NOTCH3', 'JAG1_NOTCH1', 'CD209_CEACAM1')~'novel',
#                            TRUE ~ 'other')) %>%
#   ggplot(aes(x=Tum_Ves_cor,y=-log10(Tum_Ves_cor_pval), label = LR_pairs, color=color)) +
#   scale_color_manual(values = color_scheme) +
#   geom_point() + ggrepel::geom_text_repel(max.overlaps = Inf, show.legend = FALSE)+
#   labs(x="correlation between ligand in vessel and receptor in tumor (log scale)",
#        y="-log10(p-value)")+
#   theme(
#     axis.title = element_text(size = 16),  # Axis title size for both x and y
#     axis.text = element_text(size = 14)    # Axis text size for both x and y
#   )

LR_pairs_small %>% 
  filter(ligand != receptor) %>%
  mutate(LR_pairs = case_when(Ves_Tum_cor_pval<pval_thres ~paste0(ligand, '_',receptor))) %>%
  ggplot(aes(x=Ves_Tum_beta,y=-log10(Ves_Tum_cor_pval), label = LR_pairs)) +
  geom_point() + ggrepel::geom_text_repel(max.overlaps = Inf)+
  # labs(x="correlation between ligand in vessel and receptor in tumor",
  labs(x="effect size: ligand in vessel ~ receptor in tumor (log scale)",
       y="-log10(p-value)")+
  theme(
    axis.title = element_text(size = 16),  # Axis title size for both x and y
    axis.text = element_text(size = 14)    # Axis text size for both x and y
  )

# wide to long
# data_long <- gather(LR_pairs_small, key = "variable", value = "value", -c('ligand','receptor'))
data_long_cor <- gather(LR_pairs_small, key = "LR_group", value = "cor", -c('ligand','receptor'), ends_with("cor"))
data_long_cor$LR_group <- str_replace(data_long_cor$LR_group, "_cor", "")
data_long_pval <- gather(LR_pairs_small, key = "LR_group", value = "pval", -c('ligand','receptor'), ends_with("pval"))
data_long_pval$LR_group <- str_replace(data_long_pval$LR_group, "_cor_pval", "")
data_long <- merge(data_long_cor,data_long_pval, by=c('ligand','receptor','LR_group'))

pval_thres <- 0.01

data_long <- data_long %>% 
  filter(!LR_group %in% c('Tum_Ves','Ves_Tum')) %>%
  filter(ligand != receptor) %>%
  mutate(LR_pairs = case_when(pval<pval_thres ~paste0(ligand, '_',receptor)))

pos <- position_jitter(width = 0.3, seed = 2)
# tum_ves
data_long %>% 
  filter(endsWith(LR_group,'Tum_Ves')) %>% 
  ggplot(aes(x = LR_group, y = cor, label=LR_pairs)) +
  geom_boxplot(width=0.5)+
  theme_minimal() +
  coord_flip() +
  geom_label_repel(size=3, max.overlaps = Inf,position = pos,angle=30,min.segment.length = 0)+
  labs(y="correlation between ligand in tumor and receptor in vessel",
       x="ROI subtype")+
  theme(
    axis.title = element_text(size = 12),  # Axis title size for both x and y
    axis.text = element_text(size = 14)    # Axis text size for both x and y
  )

# ves_tumor
data_long %>% 
  filter(endsWith(LR_group,'Ves_Tum')) %>% 
  ggplot(aes(x = LR_group, y = cor, label=LR_pairs)) +
  geom_boxplot(width=0.5)+
  theme_minimal() +
  coord_flip() +
  geom_label_repel(size=3, max.overlaps = Inf,position = pos,angle=30,min.segment.length = 0)+
  labs(y="correlation between ligand in vessel and receptor in tumor",
       x="ROI subtype")+
  theme(
    axis.title = element_text(size = 12),  # Axis title size for both x and y
    axis.text = element_text(size = 14)    # Axis text size for both x and y
  )

# show correlation by T1T2T3 groups of select L-R pairs
Tum_genes_interest <- c('VEGFA','CSF1','PDGFA','HLA-DRB3','LGALS9','LGALS9','SPP1','LGALS9') 
Ves_genes_interest <- c('FLT1','CSF1R','PDGFRB','CD4','HAVCR2','CD44','CD44','PTPRC') 

for (int in 1:length(Tum_genes_interest)){
  T_gene_exp <- Tum[Tum_genes_interest[int],]
  V_gene_exp <- Ves[Ves_genes_interest[int],]
  T_V <- as.data.frame(cbind(t(T_gene_exp),t(V_gene_exp))) %>% rownames_to_column('Tum_AOI')
  T_V <- T_V %>% mutate(group = case_when(Tum_AOI %in% tumor_clst1 ~ 'T1',
                                         Tum_AOI %in% tumor_clst2 ~ 'T2',
                                         Tum_AOI %in% tumor_clst3 ~ 'T3'))
  
  p <- ggplot(data=T_V, aes(x = log(get(Tum_genes_interest[[int]])), y = log(get(Ves_genes_interest[[int]])))) +
    geom_point() +
    xlab(paste0('log(',Tum_genes_interest[[int]], ') in Tumor AOI')) +
    ylab(paste0('log(',Ves_genes_interest[[int]], ') in Vessel AOI')) +
    stat_cor(size = 8)+
    geom_smooth(method = "lm", se = FALSE)+
  theme(
    axis.title = element_text(size = 16),  # Axis title size for both x and y
    axis.text = element_text(size = 14)    # Axis text size for both x and y
  )
  print(p)
  
  p <- ggplot(data=T_V, aes(x = log(get(Tum_genes_interest[[int]])), y = log(get(Ves_genes_interest[[int]])))) +
    geom_point() +
    xlab(paste0('log(',Tum_genes_interest[[int]], ') in Tumor AOI')) +
    ylab(paste0('log(',Ves_genes_interest[[int]], ') in Vessel AOI')) +
    facet_wrap(~ group) +
    stat_cor(size = 5)+
    geom_smooth(method = "lm", se = FALSE)+
  theme(
    axis.title = element_text(size = 16),  # Axis title size for both x and y
    axis.text = element_text(size = 14)    # Axis text size for both x and y
  )
  print(p)
}

dev.off()
# save table
# write_csv(LR_pairs_small,paste0(output_path,'/CellChat_cor.csv'))

```
